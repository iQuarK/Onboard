class Application < ActiveRecord::Base

  # -------------------------------------------------------------------------------------------------------------------
  # Attributes
  # -------------------------------------------------------------------------------------------------------------------
  mount_uploader :resume, ResumeUploader

  # -------------------------------------------------------------------------------------------------------------------
  # Validations
  # -------------------------------------------------------------------------------------------------------------------

  validates_presence_of :name, :email

  # -------------------------------------------------------------------------------------------------------------------
  # Associations
  # -------------------------------------------------------------------------------------------------------------------

  belongs_to :user
  belongs_to :job
  has_many :notes
  has_many :attachments, as: :attachable, dependent: :destroy

  # -------------------------------------------------------------------------------------------------------------------
  # Nested Attributes
  # -------------------------------------------------------------------------------------------------------------------
  accepts_nested_attributes_for :attachments, allow_destroy: true, reject_if: :all_blank


  # -------------------------------------------------------------------------------------------------------------------
  # Constants
  # -------------------------------------------------------------------------------------------------------------------
  STAGES = {
    0 => 'Applied',
    1 => 'Rejected',
    2 => 'Under Review',
    3 => 'Interviewing',
    4 => 'Hired'
  }


  # -------------------------------------------------------------------------------------------------------------------
  # Named Scopes
  # -------------------------------------------------------------------------------------------------------------------
  scope :applied, -> { where(stage: 0) }
  scope :rejected, -> { where(stage: 1) }
  scope :under_review, -> { where(stage: 2) }
  scope :interviewing, -> { where(stage: 3) }
  scope :hired, -> { where(stage: 4) }


  # -------------------------------------------------------------------------------------------------------------------
  # Callbacks
  # -------------------------------------------------------------------------------------------------------------------

  after_create :send_emails

  # -------------------------------------------------------------------------------------------------------------------
  # Public Methods
  # -------------------------------------------------------------------------------------------------------------------



  # -------------------------------------------------------------------------------------------------------------------
  # Private Methods
  # -------------------------------------------------------------------------------------------------------------------
  private

  def send_emails
    ApplicationMailer.thanks(self).deliver # For the applicant
    ApplicationMailer.new_application(self).deliver # For the company administrators
  end

end
